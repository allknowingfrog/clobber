<!DOCTYPE html>
<html lang="en">
<head>
<title>Clobber</title>
<meta charset="UTF-8">
<style>
body {
    background: gray;
}
#canvas {
    background: black;
    float: left;
}
#sidebar {
    background: white;
    float: left;
}
</style>
<script src="jquery-2.1.3.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
var socket = io.connect();

var canvas = {};
var CANVAS_W;
var CANVAS_H;
var ctx = {};

var TILE_W;
var TILE_H;

var map;

var tiles = {
    p0: new Image(),
    p1: new Image(),
    p2: new Image(),
    p3: new Image(),
    village:  new Image(),
    troop: new Image(),
    tower: new Image(),
    draw: function(ctx, tile, x, y) {
        ctx.drawImage(this[tile], x-(TILE_W/2), y-(TILE_H/2), TILE_W, TILE_H);
    }
};
tiles.p0.src = 'green.svg';
tiles.p1.src = 'brown.svg';
tiles.p2.src = 'blue.svg';
tiles.p3.src = 'red.svg';
tiles.village.src = 'village.svg';
tiles.troop.src = 'troop1.svg';
tiles.tower.src = 'tower.svg';

function init(data) {
    console.log('init');
    map = data.map;
    //console.log(JSON.stringify(data.map));

    canvas.main = document.getElementById("canvas");
    ctx.main = canvas.main.getContext("2d");
    canvas.sidebar = document.getElementById("sidebar");
    ctx.sidebar = canvas.sidebar.getContext("2d");

    setCanvasWidth(localStorage.getItem("canvas-width"));

    //ctx.sidebar.font = fontSize + "px Arial";
    //ctx.sidebar.fillStyle = "white";

    canvas.main.onclick = function(e) {
        // find pixel location of click relative to origin
        var rect = canvas.main.getBoundingClientRect();
        var xClick = e.clientX - rect.left - (CANVAS_W/2);
        var yClick = e.clientY - rect.top - (CANVAS_H/2);
        var x = xClick * (2/3) / (TILE_W/2);
        var y = ((-xClick/3) + (Math.sqrt(3)/3 * yClick))/(TILE_W/2);
        var coords = cube_round(x, y);
        console.log(coords.x + ", " + coords.y);
        mapClick(coords.x, coords.y);
    }

    draw();
}

function mapClick(x, y) {
    var offset = Math.floor(map.length/2);
    x += offset;
    y += offset;
    if(map[x] && map[x][y]) {
        if(map[x][y].entity && map[x][y].entity.id == 'village') {
            console.log('village: '+map[x][y].entity.bank);
        } else {
            console.log('cell');
        }
    } else {
        console.log('null');
    }
}

function cube_round(x, y) {
    var z = -x-y;

    var rx = Math.round(x);
    var ry = Math.round(y);
    var rz = Math.round(z);

    var dx = Math.abs(rx-x);
    var dy = Math.abs(ry-y);
    var dz = Math.abs(rz-z);

    if(dx > dy && dx > dz) {
        rx = -ry-rz;
    } else if(dy > dz) {
        ry = -rx-rz;
    } else {
        rz = -rx-ry;
    }

    return {x: rx, y: ry};
}

function setCanvasWidth(width) {
    CANVAS_W = width || 600;
    localStorage.setItem('canvas-width', width);
    TILE_W = CANVAS_W / ((.75 * map.length) + 2);
    TILE_H = Math.sqrt(3)/2 * TILE_W;
    CANVAS_H = TILE_H * (map.length + 1);

    canvas.main.width = CANVAS_W;
    canvas.main.height = CANVAS_H;
    canvas.sidebar.width = TILE_W * 4;
    canvas.sidebar.height = CANVAS_H;

    return "canvas width set: " + width;
}

function draw() {
    console.log('draw');
    var xStart = (CANVAS_W / 2);
    var yStart = (CANVAS_H / 2);
    var origin = Math.floor(map.length/2);
    var structure, tile, player, xRel, yRel, xDraw, yDraw;
    ctx.main.clearRect(0, 0, CANVAS_W, CANVAS_H);
    for(var x=0; x<map.length; x++) {
        for(var y=0; y<map.length; y++) {
            cell = map[x][y];
            if(cell) {
                xRel = x - origin;
                yRel = y - origin;
                xDraw = xStart + (xRel * (.75 * TILE_W));
                yDraw = yStart + ((yRel + (xRel / 2)) * TILE_H);
                tiles.draw(ctx.main, 'p'+cell.player, xDraw, yDraw);
                if(cell.entity) {
                    tiles.draw(ctx.main, cell.entity.id, xDraw, yDraw);
                }
            }
        }
    }
}

$(document).ready(function() {
    $('#nickname').val(localStorage.getItem('login'));
    $('#login').submit(function(e) {
        e.preventDefault();
        socket.emit('login', $('#nickname').val(), function(data) {
            if(data) {
                localStorage.setItem('login', data.login);
                $('#loginDiv').hide();
                $('#gameDiv').show();
                init(data);
            } else {
                $('#output').html('That username is already taken! Try again.');
            }
        });
        $('#nickname').val('');
    });
    socket.on('update', function(data) {
        map = data.map;
        draw();
    });
});
</script>

</head>

<body>

<div id="loginDiv" style="margin:50px;">
    <form id="login">
        <span>Enter a username:</span>
        <input style="width:150px;" id="nickname" style="margin-left:5px;">
        <input type="submit" value="Login">
    </form>
</div>

<div id="gameDiv" style="width:100%;display:none;">
    <canvas id="canvas"></canvas>
    <canvas id="sidebar"></canvas>
</div>

<div id="output" style="width:100%;"></div>
</body>

</html>
